# 占位符提取/恢复架构 - 测试报告
生成时间: 2025-11-10

## 架构改进

### 问题
旧架构依赖模型遵守prompt指令保留占位符，但测试显示模型会删除 `{i}`, `{/i}` 等标签，成功率仅 60%。

### 解决方案
1. **提取阶段**: 翻译前用正则提取所有占位符，替换为 `〔0〕〔1〕` 全角括号标记
2. **翻译阶段**: 模型只看到纯文本 + 全角标记，大幅降低干扰
3. **恢复阶段**: 翻译后强制将 `〔N〕` 替换回原始占位符（代码执行，100%准确）

### 关键改进点
- 占位符格式: `__PH0__` → `〔0〕` (全角括号，模型不会删除)
- 验证逻辑: 对比 en_original vs zh_final (都含原始占位符)
- 自动修复: 针对 newline_count_diff 自动去除末尾多余换行

## 测试结果

### 小样本测试 (20条)
```
总数: 20
成功: 19
失败: 1 (换行符问题)
占位符保留率: 95.0%
```

### 大样本测试 (100条)
```
总数: 97 (过滤掉3条非对话)
成功: 93
失败: 4 (全部为换行符问题，无占位符丢失)
占位符保留率: 95.9%
翻译速度: 0.31秒/条 (3 workers)
```

### 占位符保留验证
```
含占位符的译文: 36条
检查结果: 100% 正确保留
样本:
  - {i}...{/i} ✓
  - [name], [pov], [ls], [bs] ✓
  - 所有成对标签完整 ✓
```

## 对比分析

| 指标 | 旧架构 (Prompt-based) | 新架构 (Extract-Restore) |
|------|----------------------|--------------------------|
| 占位符保留率 | 60% | **95.9%** |
| 失败原因分布 | 占位符删除 80% | 换行符 100% |
| 模型负担 | 6种占位符规则 | 只需保留〔N〕 |
| Prompt Token | 280 | 180 |
| 可靠性 | 依赖模型理解 | 代码强制执行 |
| 提升幅度 | - | **+58.3%** |

## 失败案例分析

所有4个失败案例均为 `newline_count_diff`：
- game/intro.rpy:19:0 - 长句可能被模型加换行
- game/intro.rpy:40:1 - 短句片段
- game/intro.rpy:56:0 - 对话台词
- game/intro.rpy:64:0 - 叙事文本

**根本原因**: 模型有时会优化可读性而加换行，与占位符无关。

**改进方向**:
1. 增强 retry 逻辑中的换行符检测 ✓ (已实现)
2. 自动去除末尾多余换行 ✓ (已实现)
3. 考虑放宽换行符限制（仅保留占位符严格校验）

## 性能指标

- **并发性能**: 3 workers → 0.31秒/条
- **GPU 占用**: 96% (满载)
- **VRAM 使用**: 4968/8151 MB (61%)
- **错误恢复**: 网络超时自动重试，指数退避

## 结论

✅ **占位符提取/恢复架构验证成功**
- 占位符保留率从 60% 提升至 95.9%
- 所有失败均为换行符问题（可接受的边界case）
- 代码强制执行确保 100% 占位符准确性
- 适合生产环境大规模翻译

**建议**: 投入生产使用，继续监控换行符问题。
